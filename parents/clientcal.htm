<?
if(isset($_REQUEST['tsubmit']))					/*if we came from the choose_tutor.php page*/
{
		$tinfo=$_REQUEST['tselect'];
		//parse received string to extract tid and tutor's name
		$tarr=explode("|",$tinfo);
		$tid=$tarr[0];
		$_SESSION['tid']=$tid;
		$tutor_name=$tarr[1];

}
else
	if(isset($_REQUEST['choose_tutor_submit'])) /*if we have chosen tutor on this page from the drop down*/
	{
		$tinfo=$_REQUEST['tutor_select'];
		//parse received string to extract tid and tutor's name
		$tarr=explode("|",$tinfo);
		$tid=$tarr[0];
		$_SESSION['tid']=$tid;
		$tutor_name=$tarr[1];	
	}
	else										/*if none of those previous, we ask for tutor we already worked with*/
	{
		if(isset($_REQUEST['tutor_id']))
		{	
			$tid=$_REQUEST['tutor_id'];
			$result=runquery("select first_name, last_name from PT_Tutors where id='$tid'");
			$row=mysql_fetch_row($result);
			if($tid==1)
				$tutor_name= $row[0] . " T.";
			else	
				$tutor_name=$row[0] . " ".substr($row[1],0,1) . ".";
					
		}	
		else
		{
		$query = "		select pt.id, pt.first_name, pt.last_name
						from PTSchedInfo2 pts
							join PT_Tutors pt
								on pt.id=pts.tid
						where fid='$famid'
						order by start_date desc";
		$res = runquery($query);
		$tutors_num=mysql_num_rows($res);			
		if($tutors_num>0)
		{	
				
			$row=mysql_fetch_row($res);
			$tid=$row[0];
			$_SESSION['tid']=$tid;
			if($row[0]==1)
				$tutor_name= $row[1] . " T.";
			else	
				$tutor_name=$row[1] . " ".substr($row[2],0,1) . ".";
		}
		else
		{
			$query = "	select pt.id, pt.first_name, pt.last_name
						from PTSchedInfo pts
							join PT_Tutors pt
								on pt.id=pts.tid
						where sid='$famid'
						order by start_date desc";
			$res = runquery($query);
			$tutors_num=mysql_num_rows($res);			
			if($tutors_num>0)
			{	
				
				$row=mysql_fetch_row($res);
				$tid=$row[0];
				$_SESSION['tid']=$tid;
				if($row[0]==1)
					$tutor_name= $row[1] . " T.";
				else	
					$tutor_name=$row[1] . " ".substr($row[2],0,1) . ".";
			}
			else
			{
				$query = 
				"		select pt.id, pt.first_name, pt.last_name 
						from  PT_Tutors pt
							join PTAddedApp2 ap
								on ap.tid=pt.id 
						where fid='$famid' 
						order by date desc";
				$res = runquery($query);
				$tutors_num=mysql_num_rows($res);			
				if($tutors_num>0)
				{	
					
					$row=mysql_fetch_row($res);
					$tid=$row[0];
					$_SESSION['tid']=$tid;
					if($row[0]==1)
					$tutor_name= $row[1] . " T.";
					else	
						$tutor_name=$row[1] . " ".substr($row[2],0,1) . ".";
					
				}
				else
				{
					$query = "	select pt.id, pt.first_name, pt.last_name 
								from  PT_Tutors pt
									join PTAddedApp ap
										on ap.tid=pt.id 
								where sid='$famid'
								order by date desc";
					$res = runquery($query);
					$tutors_num=mysql_num_rows($res);
					if($tutors_num>0)
					{	
						$row=mysql_fetch_row($res);
						$tid=$row[0];
						$_SESSION['tid']=$tid;
						if($row[0]==1)
							$tutor_name= $row[1] . " T.";
						else	
							$tutor_name=$row[1] . " ".substr($row[2],0,1) . ".";
					}
					else								/*new parent, ask him to choose tutor*/
					{
						
						$tutor_name="You havent't worked yet with us. Please choose tutor <a href='choose_tutor.php'>here</a>.";
					
					}
				}

			}		
		}
		}
	}
?>
<?
	//function writes appropriate ordinal number for given day of month. 
	function write_day($d)
	{
		switch($d)
		{	case 1:
				$date="st";
				break;
			case 2:
				$date="nd";
				break;
			case 3:
				$date="rd";
				break;
			default:
				$date="th";
		}
		return "<sup>". $date . "</sup>";	

	}
	
?>
<body>
<table width="686" border="0" cellpadding="5" cellspacing="0" bgcolor="#ECFFEC" >
  <tr >
    <td height="25" colspan="2"" valign="top" >
       <?
		
		if(isset($tid))										/*if tutor is chosen*/
		{
			
			echo"<table><tr><td><span class='Head2_Green'>";
			//write title
			$week_start="$day".write_day($day);
			$seventh=($day+6) % date("t");
			$mon=date(M);
			$week_end="$seventh" . write_day($seventh);
			$date_string="$mon. $week_start - $week_end";
			echo"$tutor_name's Calendar For " . $date_string;
			
			echo"      </span><br/>
			To schedule a session, click on the time you would like to add.<br/>
			To cancel a session, click on the session you would like to cancel. <br/>
			To see the calendar for different tutor, choose a tutor from drop down menu.";	
			echo"</td><td><br/><br/><br/><br/><form name='select_tutor_form' action='clientcal.php' method='get'><select name='tselect' class='form_style'>";
			$query="select first_name, last_name, id from PT_Tutors";
			$result=runquery($query);	
			while($row=mysql_fetch_row($result))
			{
				if($row[2]==1)
					$tname= $row[0] . " T.";
				else	
				$tname=$row[0] . " ".substr($row[1],0,1) . ".";
				echo"<option value='$row[2]|$tname'>$tname</option>";	
				
			}
			echo"<input type='submit' name='tsubmit' class='form_style'/></form></td></tr></table>";
		?>
 
	   <?
	   }
	   else												//if not, tell him to choose tutor
	   {
			echo "<span>$tutor_name</span>";			//$tutor_name here is string which tells the parent to choose the tutor
	   
	   }
	   
	   ?>
	  
	  </td>
    <td width="96" rowspan="3"" valign="top"><div align="right"><span class="style3">    </span><span class="Head2">      </span>
      <? putParentsLinks(); ?>
      <br>
      <br>
	<table border=1>
	<tr>
		<td style="width: 20px;background-color:#ffffff">&nbsp;</td>
		<td>Open</td>
	</tr>
	<tr>
		<td style="width: 20px;background-color:#c0c0c0">&nbsp;</td>
		<td>Unavailable</td>
	</tr>
	<tr>
		<td style="width: 20px;background-color:#00ee00">&nbsp;</td>
		<td>Your appt.</td>
	</tr>
	<tr>
		<td style="width: 20px;background-color:#ee0000">&nbsp;</td>
		<td>Student</td>
	</tr>
	</table>      
      <br>
      <span class="Head2"><img src="../images/374wspacer.gif" width="120" height="2"></span>
    </div></td>
  </tr>
  <tr>
    <td width="1" rowspan="2" align="center" valign="bottom"><div align="center"><br>
          <br>
    </div>      <div align="left"></div></td>
    <td width="559" height="66" valign="top"> <p>
<?
if(isset($tid))
{
$i = 0;
$QStr = "select id as fid, students from PT_Family_Info";
if(!($StudentInfoRS = mysql_query($QStr))){
	echo "$QStr <br>" . mysql_error();
}
//get each students info
while($arStudentInfo = mysql_fetch_array($StudentInfoRS)){

	// get the scheduling information for the student
	if($getClientCalInfo = getClientCalInfo($month, $year, $arStudentInfo[0], $tid))
	{
		while (list ($key, $value) = each($getClientCalInfo)){

		   $SI[$i]["name"] = $arStudentInfo[1];
		   $SI[$i]["fid"] = $arStudentInfo[0];
		   $SI[$i]["hrs"] =  $value["hours"];
		   $SI[$i]["start"] = $value["start_time"];
		   $SI[$i]["dom"] = $key;
		   $SI[$i]["rate"] = $value["rate"];
		   $SI[$i]["date"] = $value["date"];
		   $i = $i + 1;
			}
		} // end if	
	}
	

if($month>1)
	{
		$prev_month=$month-1;
		$twt_of_prevmonth="$year-$prev_month-23";
	}
	else
	{
		$prev_year=$year-1;
		$twt_of_prevmonth="$prev_year-12-23";
	}
	
	
if($month <12){
		$next_month = $month + 1;
		$sixth_of_nextmonth = "$year-$next_month-06";
		
	} else {
		$next_year = $year + 1;
		$sixth_of_nextmonth = "$next_year-01-06";
		
	}	
	/*
$start_date = "$year-$month-01";
$end_date = "$year-$month-31";*/

/*recurring appts of the chosen tutor */	
$query = "SELECT start_date, end_date, start_time, end_time FROM PT_Recurring_Appt WHERE tid = '$tid' AND start_date >= '$twt_of_prevmonth' AND end_date <='$sixth_of_nextmonth'";


$result = mysql_query($query);

$t_unavail = Array();
while($rec = mysql_fetch_assoc($result))
{
	$t_unavail[]=$rec;
	
}

$query = "SELECT date as start_date, date as end_date, start_time, end_time FROM PT_Other_Appt WHERE tutor_id = '$tid' AND date >= '$twt_of_prevmonth' AND date <='$sixth_of_nextmonth'";


$result = mysql_query($query);
//echo mysql_num_rows($result);
while($rec = mysql_fetch_assoc($result))
{
	$t_unavail[]=$rec;
}

$start_date=$twt_of_prevmonth;
$end_date=$sixth_of_nextmonth;

 //////// SPEC AND NORM TIMES //////////

$query = "SELECT date as start_date, date as end_date, clock_in, clock_out FROM PT_SchedSS_Spec WHERE tutor_id = '$tid' AND date >= '$start_date' AND date <='$end_date'";
		
		
$times_res = mysql_query($query);

if(mysql_num_rows($times_res) == 0)
{
	$dow = date("N", strtotime($date));
	
	
	
	$query = "SELECT * FROM PT_SchedSS_Norm WHERE tutor_id = $tid AND (
	(start_date >= '$start_date' AND end_date <= '$end_date') OR
	(start_date >= '$start_date' AND end_date > '$end_date') OR
	(start_date <= '$start_date' AND end_date > '$start_date'))";
	$times_res = mysql_query($query);
}


if(mysql_num_rows($times_res)>0)
{
	
	while($times = mysql_fetch_object($times_res))
	{
		$arr = Array();
		
		
		$arr["start_date"]=$times->start_date;
		$arr["end_date"]=$times->end_date;
		$arr["start_time"]=$times->clock_in;
		$arr["end_time"]=$times->clock_out;
		
		if(isset($times->dow))
			$arr["dow"]=$times->dow;
		
		$t_unavail[]=$arr;
	}
}

// echo "el array <pre>";
 //print_r($t_unavail);
// echo "</pre>";

//echo "this is the array that is passed.  month and year are $month and $year<BR>";
//printarray($SI);
// $rate = $_REQUEST['rate'];


$irate = $_REQUEST['rate'];
$itype = $_REQUEST['type'];

$arSS = Array();
$arUnav  = Array();

$sundate = "$year-$month-$day";
client_cal($SI, $arSS, $arUnav, $famid, $sundate, $t_unavail, $tid);    //$tid is added to pass info about tutor

 
 
$extras = '';
if ($_GET['month'] > 0) {
	$extras = "&month=$_GET[month]&day=$_GET[day]&year=$_GET[year]";
}

if ($msg != "") {
	echo "<script type='text/javascript'>alert(\"$msg\");window.location.href='/parents/clientcal.php?tutor_id=$_SESSION[tid]" . $extras . "';</script>
";
}
}
?>   
   
   
    </td>
  </tr>
  <tr>
    <td height="40" valign="top">&nbsp;</td>
  </tr>
</table>
